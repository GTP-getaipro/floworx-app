# Email Provider and Business Type Selection API

## Overview
This API extends the FloWorx onboarding system with email provider selection and enhanced business type functionality.

## Authentication
All endpoints require a valid JWT token in the Authorization header:
```
Authorization: Bearer <your-jwt-token>
```

## Endpoints

### 1. Get Onboarding Status
**GET** `/api/onboarding/status`

Returns comprehensive onboarding status including email provider and business type information.

**Response:**
```json
{
  "user": {
    "emailVerified": true,
    "onboardingCompleted": false,
    "firstName": "John",
    "companyName": "Acme Corp"
  },
  "googleConnected": false,
  "emailProvider": "gmail",
  "businessTypeId": 1,
  "businessTypes": [
    {
      "id": 1,
      "name": "Hot Tub & Spa",
      "description": "Email automation for hot tub dealers..."
    }
  ],
  "onboardingComplete": false,
  "customSettings": {},
  "completedSteps": ["business-categories"],
  "stepData": {},
  "nextStep": "google-connection"
}
```

### 2. Select Email Provider
**POST** `/api/onboarding/email-provider`

Select the user's email provider (Gmail or Outlook).

**Request Body:**
```json
{
  "provider": "gmail"  // or "outlook"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Email provider selected successfully",
  "data": {
    "provider": "gmail"
  }
}
```

**Validation:**
- `provider` must be either "gmail" or "outlook"

### 3. Save Custom Settings
**POST** `/api/onboarding/custom-settings`

Save custom onboarding settings for the user.

**Request Body:**
```json
{
  "settings": {
    "emailNotifications": true,
    "autoArchive": false,
    "priorityKeywords": ["urgent", "emergency"],
    "businessHours": {
      "enabled": true,
      "timezone": "America/New_York",
      "start": "09:00",
      "end": "17:00",
      "days": ["monday", "tuesday", "wednesday", "thursday", "friday"]
    },
    "customLabels": [
      {
        "name": "High Priority",
        "color": "#ff0000",
        "priority": "high"
      }
    ]
  }
}
```

**Response:**
```json
{
  "success": true,
  "message": "Custom settings updated successfully",
  "data": {
    "settings": { /* settings object */ }
  }
}
```

### 4. Select Business Type
**POST** `/api/business-types/select`

Select a business type for the user (existing endpoint, enhanced).

**Request Body:**
```json
{
  "businessTypeId": 1
}
```

**Response:**
```json
{
  "success": true,
  "message": "Business type selected successfully",
  "data": {
    "businessTypeId": 1,
    "businessTypeName": "Hot Tub & Spa"
  }
}
```

## Onboarding Flow

The new onboarding flow follows this sequence:

1. **Email Provider Selection** (`nextStep: "email-provider"`)
   - User selects Gmail or Outlook
   - Updates user's email provider preference

2. **Business Type Selection** (`nextStep: "business-type"`)
   - User selects from available business types
   - Configures industry-specific settings

3. **Google Connection** (`nextStep: "google-connection"`)
   - User connects their email account via OAuth
   - Enables email automation features

4. **Business Categories** (`nextStep: "business-categories"`)
   - Configure email categories for the business
   - Set up classification rules

5. **Label Mapping** (`nextStep: "label-mapping"`)
   - Map business categories to Gmail labels
   - Configure automated labeling

6. **Team Setup** (`nextStep: "team-setup"`)
   - Configure team notifications
   - Set up collaboration features

7. **Workflow Deployment** (`nextStep: "workflow-deployment"`)
   - Deploy n8n automation workflows
   - Activate email processing

## Error Handling

All endpoints return consistent error responses:

```json
{
  "success": false,
  "error": "Validation failed",
  "message": "Provider must be either gmail or outlook",
  "details": [
    {
      "field": "provider",
      "message": "Provider must be either gmail or outlook"
    }
  ]
}
```

Common HTTP status codes:
- `200` - Success
- `400` - Bad Request (validation errors)
- `401` - Unauthorized (missing or invalid token)
- `404` - Not Found
- `500` - Internal Server Error

## Database Schema

### Users Table (Enhanced)
```sql
ALTER TABLE users ADD COLUMN email_provider VARCHAR(20);
```

### User Configurations Table (New)
```sql
CREATE TABLE user_configurations (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  email_provider VARCHAR(20),
  business_type_id BIGINT REFERENCES business_types(id),
  custom_settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id)
);
```

## Testing

Run the test suite:
```bash
npm test -- --testNamePattern="Email Provider"
```

Test individual endpoints:
```bash
node test-email-provider-endpoints.js
```
