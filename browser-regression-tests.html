<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FloWorx Comprehensive Regression Tests</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .progress-container {
            padding: 0 30px 20px 30px;
            background: #f8f9fa;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .results {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .test-section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-section-title {
            font-weight: 600;
            font-size: 1.1em;
            color: #2c3e50;
        }
        
        .test-section-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-pending {
            background: #ffc107;
            color: #856404;
        }
        
        .status-running {
            background: #17a2b8;
            color: white;
        }
        
        .status-success {
            background: #28a745;
            color: white;
        }
        
        .status-error {
            background: #dc3545;
            color: white;
        }
        
        .test-section-content {
            padding: 20px;
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .test-item:last-child {
            border-bottom: none;
        }
        
        .test-name {
            flex: 1;
            font-weight: 500;
        }
        
        .test-result {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .result-success {
            background: #d4edda;
            color: #155724;
        }
        
        .result-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .result-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .summary-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .summary-number {
            font-size: 2em;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .summary-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-timestamp {
            color: #95a5a6;
            margin-right: 10px;
        }
        
        .log-success {
            color: #2ecc71;
        }
        
        .log-error {
            color: #e74c3c;
        }
        
        .log-info {
            color: #3498db;
        }
        
        .log-warning {
            color: #f39c12;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .running {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç FloWorx Comprehensive Regression Tests</h1>
            <p>Complete system validation including routers, database, users, and configurations</p>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="runAllTests()">üöÄ Run All Tests</button>
            <button class="btn btn-secondary" onclick="runRouterTests()">üîó Router Tests</button>
            <button class="btn btn-secondary" onclick="runDataTests()">üìä Data Tests</button>
            <button class="btn btn-secondary" onclick="runHealthTests()">üè• Health Tests</button>
            <button class="btn btn-success" onclick="clearResults()">üßπ Clear Results</button>
            <button class="btn btn-danger" onclick="exportResults()">üìÑ Export Results</button>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div class="results" id="results">
            <!-- Test sections will be populated here -->
        </div>
        
        <div class="summary" id="summary" style="display: none;">
            <h3>üìä Test Summary</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-number" id="totalTests">0</div>
                    <div class="summary-label">Total Tests</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="passedTests">0</div>
                    <div class="summary-label">Passed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="failedTests">0</div>
                    <div class="summary-label">Failed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-number" id="successRate">0%</div>
                    <div class="summary-label">Success Rate</div>
                </div>
            </div>
        </div>
        
        <div class="log" id="log" style="display: none;">
            <div><strong>üìã Test Execution Log</strong></div>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://app.floworx-iq.com';
        let testResults = {};
        let currentTestIndex = 0;
        let totalTests = 0;
        
        const testSuites = {
            health: {
                title: 'üè• Health & Monitoring',
                tests: [
                    { name: 'Main Health Check', endpoint: '/api/health', method: 'GET', expected: [200] },
                    { name: 'Database Health', endpoint: '/api/health/db', method: 'GET', expected: [200] },
                    { name: 'Cache Health', endpoint: '/api/health/cache', method: 'GET', expected: [200, 503] },
                    { name: 'Performance Metrics', endpoint: '/api/performance', method: 'GET', expected: [200] }
                ]
            },
            auth: {
                title: 'üîê Authentication System',
                tests: [
                    { name: 'Password Requirements', endpoint: '/api/auth/password-requirements', method: 'GET', expected: [200] },
                    { name: 'Registration Endpoint', endpoint: '/api/auth/register', method: 'POST', 
                      data: { email: 'test@example.com', password: 'Test123!', firstName: 'Test', lastName: 'User' },
                      expected: [400, 409, 429] },
                    { name: 'Login Endpoint', endpoint: '/api/auth/login', method: 'POST',
                      data: { email: 'test@example.com', password: 'Test123!' },
                      expected: [401, 429] }
                ]
            },
            business: {
                title: 'üè¢ Business Configuration',
                tests: [
                    { name: 'Business Types List', endpoint: '/api/business-types', method: 'GET', expected: [200] },
                    { name: 'Business Types Count', endpoint: '/api/business-types', method: 'GET', expected: [200], 
                      validate: (data) => data.data && data.data.length >= 6 }
                ]
            },
            oauth: {
                title: 'üîó OAuth Integration',
                tests: [
                    { name: 'Google OAuth Redirect', endpoint: '/api/oauth/google', method: 'GET', expected: [302] },
                    { name: 'OAuth Callback', endpoint: '/api/oauth/google/callback', method: 'GET', expected: [302] }
                ]
            },
            protected: {
                title: 'üîí Protected Endpoints',
                tests: [
                    { name: 'User Status', endpoint: '/api/user/status', method: 'GET', expected: [401] },
                    { name: 'Dashboard Data', endpoint: '/api/dashboard', method: 'GET', expected: [401] },
                    { name: 'Onboarding Status', endpoint: '/api/onboarding/status', method: 'GET', expected: [401] },
                    { name: 'Workflow Status', endpoint: '/api/workflows/status', method: 'GET', expected: [401] },
                    { name: 'Analytics Dashboard', endpoint: '/api/analytics/dashboard', method: 'GET', expected: [401] }
                ]
            }
        };
        
        function log(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span><span class="log-${type}">${message}</span>`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
            
            // Show log if hidden
            document.getElementById('log').style.display = 'block';
        }
        
        function updateProgress(current, total) {
            const percentage = (current / total) * 100;
            document.getElementById('progressFill').style.width = `${percentage}%`;
        }
        
        function createTestSection(suiteKey, suite) {
            const section = document.createElement('div');
            section.className = 'test-section';
            section.id = `section-${suiteKey}`;
            
            section.innerHTML = `
                <div class="test-section-header">
                    <div class="test-section-title">${suite.title}</div>
                    <div class="test-section-status status-pending" id="status-${suiteKey}">Pending</div>
                </div>
                <div class="test-section-content" id="content-${suiteKey}">
                    ${suite.tests.map((test, index) => `
                        <div class="test-item" id="test-${suiteKey}-${index}">
                            <div class="test-name">${test.name}</div>
                            <div class="test-result result-pending" id="result-${suiteKey}-${index}">Pending</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            return section;
        }
        
        async function testEndpoint(test) {
            try {
                const options = {
                    method: test.method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                };
                
                if (test.data && test.method !== 'GET') {
                    options.body = JSON.stringify(test.data);
                }
                
                const response = await fetch(`${BASE_URL}${test.endpoint}`, options);
                const responseData = await response.text();
                
                let parsedData = null;
                try {
                    parsedData = JSON.parse(responseData);
                } catch (e) {
                    // Response is not JSON
                }
                
                const result = {
                    success: true,
                    status: response.status,
                    data: parsedData,
                    rawData: responseData
                };
                
                // Check if status is expected
                if (test.expected.includes(response.status)) {
                    result.passed = true;
                } else {
                    result.passed = false;
                    result.error = `Expected status ${test.expected.join(' or ')}, got ${response.status}`;
                }
                
                // Run custom validation if provided
                if (test.validate && parsedData && result.passed) {
                    try {
                        result.passed = test.validate(parsedData);
                        if (!result.passed) {
                            result.error = 'Custom validation failed';
                        }
                    } catch (e) {
                        result.passed = false;
                        result.error = `Validation error: ${e.message}`;
                    }
                }
                
                return result;
            } catch (error) {
                return {
                    success: false,
                    passed: false,
                    error: error.message
                };
            }
        }
        
        async function runTestSuite(suiteKey, suite) {
            log(`Starting ${suite.title} tests...`, 'info');
            
            const statusElement = document.getElementById(`status-${suiteKey}`);
            statusElement.textContent = 'Running';
            statusElement.className = 'test-section-status status-running running';
            
            let passed = 0;
            let failed = 0;
            
            for (let i = 0; i < suite.tests.length; i++) {
                const test = suite.tests[i];
                const testElement = document.getElementById(`test-${suiteKey}-${i}`);
                const resultElement = document.getElementById(`result-${suiteKey}-${i}`);
                
                // Mark as running
                resultElement.textContent = 'Running';
                resultElement.className = 'test-result result-pending running';
                
                log(`Testing: ${test.name}`, 'info');
                
                const result = await testEndpoint(test);
                
                if (result.passed) {
                    passed++;
                    resultElement.textContent = `‚úÖ ${result.status}`;
                    resultElement.className = 'test-result result-success';
                    log(`‚úÖ ${test.name}: ${result.status}`, 'success');
                } else {
                    failed++;
                    resultElement.textContent = `‚ùå ${result.status || 'Error'}`;
                    resultElement.className = 'test-result result-error';
                    log(`‚ùå ${test.name}: ${result.error || result.status}`, 'error');
                }
                
                currentTestIndex++;
                updateProgress(currentTestIndex, totalTests);
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Update section status
            if (failed === 0) {
                statusElement.textContent = `‚úÖ ${passed}/${suite.tests.length}`;
                statusElement.className = 'test-section-status status-success';
            } else {
                statusElement.textContent = `‚ùå ${passed}/${suite.tests.length}`;
                statusElement.className = 'test-section-status status-error';
            }
            
            testResults[suiteKey] = { passed, failed, total: suite.tests.length };
            log(`Completed ${suite.title}: ${passed} passed, ${failed} failed`, failed === 0 ? 'success' : 'error');
        }
        
        async function runAllTests() {
            log('üöÄ Starting comprehensive regression tests...', 'info');
            
            // Clear previous results
            testResults = {};
            currentTestIndex = 0;
            
            // Calculate total tests
            totalTests = Object.values(testSuites).reduce((sum, suite) => sum + suite.tests.length, 0);
            
            // Create test sections
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';
            
            Object.entries(testSuites).forEach(([key, suite]) => {
                resultsContainer.appendChild(createTestSection(key, suite));
            });
            
            // Run all test suites
            for (const [suiteKey, suite] of Object.entries(testSuites)) {
                await runTestSuite(suiteKey, suite);
            }
            
            // Show summary
            updateSummary();
            log('üéâ All tests completed!', 'success');
        }
        
        async function runRouterTests() {
            await runSpecificTests(['health', 'auth', 'business', 'oauth', 'protected']);
        }
        
        async function runDataTests() {
            await runSpecificTests(['business']);
        }
        
        async function runHealthTests() {
            await runSpecificTests(['health']);
        }
        
        async function runSpecificTests(suiteKeys) {
            testResults = {};
            currentTestIndex = 0;
            
            const selectedSuites = {};
            suiteKeys.forEach(key => {
                if (testSuites[key]) {
                    selectedSuites[key] = testSuites[key];
                }
            });
            
            totalTests = Object.values(selectedSuites).reduce((sum, suite) => sum + suite.tests.length, 0);
            
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';
            
            Object.entries(selectedSuites).forEach(([key, suite]) => {
                resultsContainer.appendChild(createTestSection(key, suite));
            });
            
            for (const [suiteKey, suite] of Object.entries(selectedSuites)) {
                await runTestSuite(suiteKey, suite);
            }
            
            updateSummary();
        }
        
        function updateSummary() {
            const summary = document.getElementById('summary');
            const totalTestsEl = document.getElementById('totalTests');
            const passedTestsEl = document.getElementById('passedTests');
            const failedTestsEl = document.getElementById('failedTests');
            const successRateEl = document.getElementById('successRate');
            
            const totals = Object.values(testResults).reduce(
                (acc, result) => ({
                    total: acc.total + result.total,
                    passed: acc.passed + result.passed,
                    failed: acc.failed + result.failed
                }),
                { total: 0, passed: 0, failed: 0 }
            );
            
            const successRate = totals.total > 0 ? Math.round((totals.passed / totals.total) * 100) : 0;
            
            totalTestsEl.textContent = totals.total;
            passedTestsEl.textContent = totals.passed;
            failedTestsEl.textContent = totals.failed;
            successRateEl.textContent = `${successRate}%`;
            
            summary.style.display = 'block';
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            document.getElementById('log').style.display = 'none';
            document.getElementById('logContent').innerHTML = '';
            document.getElementById('progressFill').style.width = '0%';
            testResults = {};
            currentTestIndex = 0;
            totalTests = 0;
        }
        
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                baseUrl: BASE_URL,
                testResults: testResults,
                summary: {
                    total: Object.values(testResults).reduce((sum, r) => sum + r.total, 0),
                    passed: Object.values(testResults).reduce((sum, r) => sum + r.passed, 0),
                    failed: Object.values(testResults).reduce((sum, r) => sum + r.failed, 0)
                }
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `floworx-regression-tests-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üìÑ Test results exported successfully', 'success');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üîç FloWorx Regression Test Suite initialized', 'info');
            log(`üéØ Target URL: ${BASE_URL}`, 'info');
            log('Click "Run All Tests" to start comprehensive validation', 'info');
        });
    </script>
</body>
</html>
